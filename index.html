<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
    <link href="https://cdn.bootcss.com/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/semantic-ui/2.4.1/semantic.min.js"></script>
    <script src="https://unpkg.com/konva@3.3.3/konva.min.js"></script>
    <meta charset="utf-8" />
    <title>Modelerjs Demo</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #f0f0f0;
        }

        #contextmenu {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            display: none;
        }
    </style>
</head>

<body>
    <div id="container"></div>
    <div class="ui basic vertical menu" id="contextmenu">
        <a class="item add-table global-level">新增表 </a>
        <a class="item drop-table table-level">删除表 </a>
        <a class="item update-relation table-level">更新关系 </a>
        <a class="item save global-level">保存位置 </a>
    </div>

    <div class="ui larger modal table-addition">
        <div class="header">新增表</div>
        <div class="content">
            <select name="schema" class="ui fluid dropdown">
                <option value="">Schema</option>
                <option value="etl">etl</option>
                <option value="stg">stg</option>
                <option value="owl">owl</option>
            </select>
            <div class="ui hidden divider"></div>
            <select name="table" multiple=""  class="ui fluid dropdown">
                <option value="">Table</option>
                <option value="history_data">history_data</option>
                <option value="device_report_data">device_report_data</option>
            </select>
        </div>
        <div class="actions">
            <div class="ui button">取消</div>
            <div class="ui positive right button">保存</div>
        </div>
    </div>

    <div class="ui larger modal table-relation">
        <div class="header">更新表关系</div>
        <div class="content">
            <div class="ui segment">
                <div class="source">
                    <select name="skills" multiple="" class="ui fluid dropdown">
                        <option value="">源表字段</option>
                        <option value="angular">Angular</option>
                        <option value="css">CSS</option>
                        <option value="design">Graphic Design</option>
                        <option value="ember">Ember</option>
                        <option value="html">HTML</option>
                        <option value="ia">Information Architecture</option>
                    </select>
                </div>
                <h4 class="ui horizontal divider">Source <i class="arrow right icon"></i> Target</h4>
                <div class="target">
                    <div class="ui fluid search selection dropdown">
                        <input type="hidden" name="country">
                        <i class="dropdown icon"></i>
                        <div class="default text">选择目标表</div>
                        <div class="menu">
                            <div class="item" data-value="af"><i class="af flag"></i>Afghanistan</div>
                            <div class="item" data-value="ax"><i class="ax flag"></i>Aland Islands</div>
                            <div class="item" data-value="al"><i class="al flag"></i>Albania</div>
                        </div>
                    </div>
                    <div class="ui hidden divider"></div>
                    <select name="skills" multiple="" class="ui fluid dropdown">
                        <option value="">选择目标表字段</option>
                        <option value="angular">Angular</option>
                        <option value="css">CSS</option>
                        <option value="design">Graphic Design</option>
                        <option value="ember">Ember</option>
                        <option value="html">HTML</option>
                        <option value="ia">Information Architecture</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="actions">
            <div class="ui button">取消</div>
            <div class="ui positive right button">保存</div>
        </div>
    </div>

    <script type="module">
        import { Designer } from "./js/designer.js";
        let designer;
        window.onload = function () {
            $('.ui.dropdown').dropdown();
            designer = new Designer({
                container: "container",
                contextmenu: "contextmenu"
            });
            let table = designer.createTable("chr.history_data");
            let cellContent = [
                ["data_time", "timestamp(6)", "时间"],
                ["mn_code", "varchar(100)", "监控点"],
                ["data_value", "numeric(12,5)", "数据值"]
            ];
            for (let i = 0; i < 3; i++) {
                table.addRow(...cellContent[i])
            };

            table = designer.createTable("rpt.owl_device_hour", 200, 300);
            cellContent = [
                ["data_time", "timestamp(6)", "时间"],
                ["device_id", "varchar(100)", "设备ID"],
                ["data_value", "numeric(12,5)", "时间"]
            ];
            for (let i = 0; i < 3; i++) {
                table.addRow(...cellContent[i])
            };

            designer.createRelation("chr.history_data", ["data_time", "data_value"], "rpt.owl_device_hour", [
                "data_time", "data_value"
            ], 0)

            table = designer.createTable("rpt.owl_enterprise_hour", 200, 500);
            cellContent = [
                ["data_time", "timestamp(6)", "时间"],
                ["enterprise_code", "varchar(100)", "企业号"],
                ["data_value", "numeric(12,5)", "时间"]
            ];
            for (let i = 0; i < 3; i++) {
                table.addRow(...cellContent[i])
            };

            designer.createRelation("rpt.owl_enterprise_hour", ["data_time", "data_value"], "rpt.owl_device_hour", [
                "data_time", "data_value"
            ]);

            designer.flush();

            $(".drop-table").click(function(){
                designer.dropTableByTableName(designer.selectedTableName);
            });

            $(".add-table").click(function(){
                $(".table-addition").modal('show')
            });

            $(".update-relation").click(function(){
                $('.table-relation').modal('show');
            });

            $(".save").click(function(){
                console.log(designer.fetchAllTablesPos());
            });
        }
    </script>
</body>

</html>